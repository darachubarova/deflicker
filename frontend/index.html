<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mask Stabilization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .upload-zone:hover {
            border-color: #3182ce;
            background: #ebf8ff;
        }

        .upload-zone.dragover {
            border-color: #3182ce;
            background: #bee3f8;
        }

        .upload-zone svg {
            width: 64px;
            height: 64px;
            color: #3182ce;
            margin-bottom: 15px;
        }

        .upload-zone p {
            color: #4a5568;
            font-size: 1.1rem;
        }

        .upload-zone .file-types {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .video-info {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
        }

        .video-info.active {
            display: block;
        }

        .video-info p {
            margin: 5px 0;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group select,
        .form-group input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #3182ce;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #3182ce;
            font-size: 1.1rem;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3182ce;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2c5aa0;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3182ce;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(49, 130, 206, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #38a169 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-message {
            text-align: center;
            color: #4a5568;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .frame-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .frame-navigation button {
            padding: 10px 20px;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .frame-navigation button:hover:not(:disabled) {
            background: #2c5aa0;
        }

        .frame-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .frame-counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            min-width: 120px;
            text-align: center;
        }

        .frame-viewer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .frame-panel {
            text-align: center;
        }

        .frame-panel h3 {
            font-size: 0.95rem;
            color: #4a5568;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .frame-panel img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }

        .metric-card.success {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
        }

        .metric-card h3 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-card .label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .frame-viewer {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Mask Stabilization</h1>
            <p>Reduce flickering in video segmentation with temporal smoothing</p>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <h2>üì§ Upload Video</h2>
            <div class="upload-zone" id="uploadZone">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p>Drag and drop your video here or click to browse</p>
                <p class="file-types">Supported formats: MP4, AVI, MOV</p>
            </div>
            <input type="file" id="fileInput" accept=".mp4,.avi,.mov" style="display: none;">
            
            <div class="video-info" id="videoInfo">
                <p><strong>File:</strong> <span id="fileName"></span></p>
                <p><strong>Resolution:</strong> <span id="resolution"></span></p>
                <p><strong>FPS:</strong> <span id="fps"></span></p>
                <p><strong>Frame Count:</strong> <span id="frameCount"></span></p>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="card" id="configSection">
            <h2>‚öôÔ∏è Configuration</h2>
            
            <div class="form-group">
                <label for="objectClass">Object Class</label>
                <select id="objectClass">
                    <option value="person">Person</option>
                    <option value="car">Car</option>
                    <option value="bus">Bus</option>
                    <option value="truck">Truck</option>
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="horse">Horse</option>
                </select>
            </div>

            <div class="form-group">
                <label for="stabilizationMethod">Stabilization Method</label>
                <select id="stabilizationMethod">
                    <option value="moving_average">Moving Average</option>
                    <option value="median_filter">Median Filter</option>
                    <option value="exponential_smoothing">Exponential Smoothing</option>
                </select>
            </div>

            <div class="form-group" id="windowSizeGroup">
                <label for="windowSize">Window Size</label>
                <div class="slider-container">
                    <input type="range" id="windowSize" min="3" max="9" step="2" value="5">
                    <span class="slider-value" id="windowSizeValue">5</span>
                </div>
            </div>

            <div class="form-group hidden" id="alphaGroup">
                <label for="alpha">Alpha (Smoothing Factor)</label>
                <div class="slider-container">
                    <input type="range" id="alpha" min="0.1" max="0.9" step="0.1" value="0.3">
                    <span class="slider-value" id="alphaValue">0.3</span>
                </div>
            </div>

            <button class="btn btn-primary" id="stabilizeBtn" disabled>
                Stabilize Video
            </button>
        </div>

        <!-- Progress Section -->
        <div class="card progress-section" id="progressSection">
            <h2>üìä Processing</h2>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="status-message" id="statusMessage">Initializing...</div>
        </div>

        <!-- Results Section -->
        <div class="card results-section" id="resultsSection">
            <h2>üéØ Results</h2>
            
            <div class="frame-navigation">
                <button id="prevFrameBtn">‚Üê Previous</button>
                <span class="frame-counter" id="frameCounter">Frame 1 of 1</span>
                <button id="nextFrameBtn">Next ‚Üí</button>
            </div>

            <div class="frame-viewer">
                <div class="frame-panel">
                    <h3>Before Stabilization</h3>
                    <img id="frameBefore" src="" alt="Before">
                </div>
                <div class="frame-panel">
                    <h3>After Stabilization</h3>
                    <img id="frameAfter" src="" alt="After">
                </div>
                <div class="frame-panel">
                    <h3>Comparison</h3>
                    <img id="frameComparison" src="" alt="Comparison">
                </div>
            </div>

            <h2 style="margin-top: 30px;">üìà Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>IoU Before</h3>
                    <div class="value" id="iouBefore">-</div>
                    <div class="label">Mean</div>
                </div>
                <div class="metric-card success">
                    <h3>IoU After</h3>
                    <div class="value" id="iouAfter">-</div>
                    <div class="label">Mean</div>
                </div>
                <div class="metric-card success">
                    <h3>Improvement</h3>
                    <div class="value" id="improvement">-</div>
                    <div class="label">Percentage</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://23.189.104.205:8000';
        
        // State
        let state = {
            jobId: null,
            currentFrame: 0,
            totalFrames: 0,
            videoInfo: null,
            isProcessing: false
        };

        // DOM Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const videoInfo = document.getElementById('videoInfo');
        const configSection = document.getElementById('configSection');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');
        const stabilizeBtn = document.getElementById('stabilizeBtn');
        const stabilizationMethod = document.getElementById('stabilizationMethod');
        const windowSizeGroup = document.getElementById('windowSizeGroup');
        const alphaGroup = document.getElementById('alphaGroup');
        const windowSize = document.getElementById('windowSize');
        const alpha = document.getElementById('alpha');
        const windowSizeValue = document.getElementById('windowSizeValue');
        const alphaValue = document.getElementById('alphaValue');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const prevFrameBtn = document.getElementById('prevFrameBtn');
        const nextFrameBtn = document.getElementById('nextFrameBtn');
        const frameCounter = document.getElementById('frameCounter');

        // Upload Zone Handlers
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Method Selection Handler
        stabilizationMethod.addEventListener('change', () => {
            const method = stabilizationMethod.value;
            if (method === 'exponential_smoothing') {
                windowSizeGroup.classList.add('hidden');
                alphaGroup.classList.remove('hidden');
            } else {
                windowSizeGroup.classList.remove('hidden');
                alphaGroup.classList.add('hidden');
            }
        });

        // Slider Value Updates
        windowSize.addEventListener('input', (e) => {
            windowSizeValue.textContent = e.target.value;
        });

        alpha.addEventListener('input', (e) => {
            alphaValue.textContent = parseFloat(e.target.value).toFixed(1);
        });

        // Stabilize Button Handler
        stabilizeBtn.addEventListener('click', async () => {
            if (state.isProcessing || !state.jobId) return;
            
            state.isProcessing = true;
            stabilizeBtn.disabled = true;
            progressSection.classList.add('active');
            resultsSection.classList.remove('active');
            
            try {
                // Step 1: Segment
                await startSegmentation();
                
                // Step 2: Wait for segmentation
                await pollStatus('segmented');
                
                // Step 3: Stabilize
                await startStabilization();
                
                // Step 4: Wait for completion
                await pollStatus('completed');
                
                // Step 5: Load results
                await loadResults();
                
                progressSection.classList.remove('active');
                resultsSection.classList.add('active');
                
            } catch (error) {
                alert('Error: ' + error.message);
                progressSection.classList.remove('active');
            } finally {
                state.isProcessing = false;
                stabilizeBtn.disabled = false;
            }
        });

        // Frame Navigation
        prevFrameBtn.addEventListener('click', () => {
            if (state.currentFrame > 0) {
                state.currentFrame--;
                updateFrameDisplay();
            }
        });

        nextFrameBtn.addEventListener('click', () => {
            if (state.currentFrame < state.totalFrames - 1) {
                state.currentFrame++;
                updateFrameDisplay();
            }
        });

        // API Functions
        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                updateProgress(0, 'Uploading video...');
                progressSection.classList.add('active');
                
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                state.jobId = data.job_id;
                state.videoInfo = data.video_info;
                
                // Display video info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('resolution').textContent = 
                    `${data.video_info.width} √ó ${data.video_info.height}`;
                document.getElementById('fps').textContent = 
                    data.video_info.fps.toFixed(2);
                document.getElementById('frameCount').textContent = 
                    data.video_info.frame_count;
                
                videoInfo.classList.add('active');
                stabilizeBtn.disabled = false;
                progressSection.classList.remove('active');
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
                progressSection.classList.remove('active');
            }
        }

        async function startSegmentation() {
            const objectClass = document.getElementById('objectClass').value;
            
            updateProgress(10, 'Starting segmentation...');
            
            const response = await fetch(`${API_BASE}/api/segment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_id: state.jobId,
                    target_class: objectClass
                })
            });
            
            if (!response.ok) {
                throw new Error('Segmentation request failed');
            }
        }

        async function startStabilization() {
            const method = stabilizationMethod.value;
            const params = {
                job_id: state.jobId,
                method: method
            };
            
            if (method === 'exponential_smoothing') {
                params.alpha = parseFloat(alpha.value);
            } else {
                params.window_size = parseInt(windowSize.value);
            }
            
            updateProgress(50, 'Starting stabilization...');
            
            const response = await fetch(`${API_BASE}/api/stabilize`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            
            if (!response.ok) {
                throw new Error('Stabilization request failed');
            }
        }

        async function pollStatus(targetStatus) {
            while (true) {
                const response = await fetch(`${API_BASE}/api/status/${state.jobId}`);
                
                if (!response.ok) {
                    throw new Error('Status check failed');
                }
                
                const status = await response.json();
                
                updateProgress(
                    status.progress * 100,
                    status.message || status.status
                );
                
                if (status.status === targetStatus) {
                    break;
                }
                
                if (status.status === 'error') {
                    throw new Error(status.message || 'Processing failed');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function loadResults() {
            // Get results info
            const resultsResponse = await fetch(`${API_BASE}/api/results/${state.jobId}`);
            const results = await resultsResponse.json();
            state.totalFrames = results.num_frames;
            state.currentFrame = 0;
            
            // Get metrics
            const metricsResponse = await fetch(`${API_BASE}/api/metrics/${state.jobId}`);
            const metrics = await metricsResponse.json();
            
            // Display metrics
            document.getElementById('iouBefore').textContent = 
                metrics.iou_before.mean.toFixed(3);
            document.getElementById('iouAfter').textContent = 
                metrics.iou_after.mean.toFixed(3);
            document.getElementById('improvement').textContent = 
                metrics.improvement.iou_improvement_percent.toFixed(1) + '%';
            
            // Load first frame
            updateFrameDisplay();
        }

        function updateFrameDisplay() {
            const frameNum = state.currentFrame;
            
            // Update counter
            frameCounter.textContent = `Frame ${frameNum + 1} of ${state.totalFrames}`;
            
            // Update buttons
            prevFrameBtn.disabled = frameNum === 0;
            nextFrameBtn.disabled = frameNum === state.totalFrames - 1;
            
            // Update images
            document.getElementById('frameBefore').src = 
                `${API_BASE}/api/frames/${state.jobId}/mask_before/${frameNum}`;
            document.getElementById('frameAfter').src = 
                `${API_BASE}/api/frames/${state.jobId}/mask_after/${frameNum}`;
            document.getElementById('frameComparison').src = 
                `${API_BASE}/api/frames/${state.jobId}/comparison/${frameNum}`;
        }

        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            statusMessage.textContent = message;
        }
    </script>
</body>
</html>
